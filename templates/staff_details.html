<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Details - {{ employee['Emp Name'] }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/accommodation.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
</head>
<body>
    <div class="top-header">
        <div class="header-left">
            <img src="{{ url_for('static', filename='images/logo1.png') }}" alt="Logo 1" class="header-logo">
        </div>
        <div class="header-center">
            <h1>Staff Details</h1>
        </div>
        <div class="header-right">
             <a href="{{ url_for('auth_bp.dashboard') }}" class="back-btn">Back to Dashboard</a>
            <img src="{{ url_for('static', filename='images/logo2.png') }}" alt="Logo 2" class="header-logo">
        </div>
    </div>

    <div class="page-container">
        <nav class="sidebar">
            <ul>
                <li><a href="{{ url_for('auth_bp.dashboard') }}">Dashboard</a></li>
                <li><a href="{{ url_for('acc_bp.accommodation_data') }}">Accommodation Data</a></li>
                <li><a href="{{ url_for('maintenance_bp.maintenance_report') }}">Maintenance Report</a></li>
                <li><a href="{{ url_for('amcs_bp.amcs_report') }}">Amcs Services</a></li>
                <li><a href="#" onclick="alert('This feature is coming soon!'); return false;">Asset reports</a></li>
                <li><a href="#" onclick="alert('This feature is coming soon!'); return false;">Store Record</a></li>
                <li><a href="#" onclick="alert('This feature is coming soon!'); return false;">Contracts</a></li>
                <li><a href="{{ url_for('settings_bp.settings_page') }}">Setting</a></li>
            </ul>
        </nav>

        <main class="main-content">
            {% with messages = get_flashed_messages(with_categories=true) %}
              {% if messages %}
                <div class="flash-message">{{ messages[0][1] }}</div>
              {% endif %}
            {% endwith %}

            <div class="details-container">
                <form class="staff-form" method="POST" action="{{ url_for('staff_bp.update_staff', sap_id=employee['SAP ID']|int_sap) }}">
                    <h3>Employee Information (Editable)</h3>
                    <div class="form-row">
                        <div class="form-group"><label>SAP ID</label><input type="text" value="{{ employee['SAP ID']|int_sap }}" readonly></div>
                        <div class="form-group"><label>Emp Name</label><input type="text" name="emp_name" value="{{ employee['Emp Name'] }}"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Designation</label><input type="text" name="designation" value="{{ employee['Designation'] }}"></div>
                        <div class="form-group">
                            <label>Department</label>
                            <select name="department">
                                {% for dept in departments %}
                                <option value="{{ dept }}" {% if dept == employee.get('Department') %}selected{% endif %}>{{ dept }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Nationality</label>
                            <select name="nationality">
                                {% for country in countries %}
                                <option value="{{ country.name }}" {% if country.name == employee.get('Nationality') %}selected{% endif %}>{{ country.name }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Status</label>
                            <select name="status">
                                {% set statuses = ['Active', 'Vacation', 'Resigned', 'Terminated'] %}
                                {% for s in statuses %}
                                <option value="{{ s }}" {% if s == employee.get('Status') %}selected{% endif %}>{{ s }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    {% set can_edit = employee['Accommodation'] in session.get('allowed_accommodations', []) or session.get('role') in ['Admin', 'Manager'] %}
                    {% if can_edit %}
                    <div class="form-actions">
                        <button type="submit" class="submit-btn">Update Details</button>
                    </div>
                    {% endif %}
                </form>

                {% if can_edit and employee.get('Status') != 'Checked-Out' %}
                <div class="actions-container">
                    <h3>Manage Employee Status</h3>
                    <div class="action-box">
                        <h4>Check Out Employee</h4>
                        <p>This will mark the employee as 'Checked-Out' and make their room vacant.</p>
                        <form method="POST" action="{{ url_for('staff_bp.checkout_staff', sap_id=employee['SAP ID']|int_sap) }}">
                            <button type="submit" class="danger-btn">Check Out</button>
                        </form>
                    </div>

                    <div class="action-box">
                        <h4>Shift Employee to New Room</h4>
                        <button type="button" id="shiftBtn" class="action-btn">Shift Out</button>
                        <form id="shiftForm" class="staff-form hidden" method="POST" action="{{ url_for('staff_bp.shift_staff', sap_id=employee['SAP ID']|int_sap) }}">
                             <div class="form-row">
                                <div class="form-group">
                                    <label>New Accommodation</label>
                                    <select id="new_accommodation" name="new_accommodation" required>
                                        <option value="" disabled selected>Select Accommodation</option>
                                        {% for acc in accommodations %}<option value="{{ acc }}">{{ acc }}</option>{% endfor %}
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>New Room (Vacant)</label>
                                    <select id="new_room" name="new_room" required>
                                        <option value="" disabled selected>Select Room</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-actions">
                                <button type="submit" class="submit-btn">Confirm Shift</button>
                            </div>
                        </form>
                    </div>
                </div>
                {% endif %}
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const shiftBtn = document.getElementById('shiftBtn');
            const shiftForm = document.getElementById('shiftForm');
            const newAccommodationSelect = document.getElementById('new_accommodation');
            const newRoomSelect = document.getElementById('new_room');

            if (shiftBtn) {
                shiftBtn.addEventListener('click', () => {
                    shiftForm.classList.toggle('hidden');
                });
            }

            if (newAccommodationSelect) {
                newAccommodationSelect.addEventListener('change', async function() {
                    const accName = this.value;
                    newRoomSelect.innerHTML = '<option value="" disabled selected>Loading...</option>';
                    if (!accName) return;
                    
                    const response = await fetch(`/get_vacant_rooms/${accName}`);
                    const rooms = await response.json();
                    
                    newRoomSelect.innerHTML = '<option value="" disabled selected>Select Room</option>';
                    rooms.forEach(room => {
                        const option = document.createElement('option');
                        option.value = room;
                        option.textContent = room;
                        newRoomSelect.appendChild(option);
                    });
                });
            }
        });
    </script>
</body>
</html>